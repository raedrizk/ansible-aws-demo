---
- name: Gather the instance IPs
  amazon.aws.ec2_instance_info:
    region: "{{ aws_region }}"
    filters:
      instance-state-name: running
      tag:Name: "{{ ec2_name_tag }}"
      tag:Provisioner: "{{ provisioner_tag }}"
  register: ec2

- name: Terminate Existing EC2 Instances if found
  amazon.aws.ec2_instance:
    instance_ids: "{{ ec2.instances }}"
    state: absent
    region: "{{ aws_region }}"
    wait: true

- name: Delete Security Group for {{ ec2_name_tag }} WebServers
  ignore_errors: true
  register: delete_sg
  amazon.aws.ec2_security_group:
    name: "{{ sg_name_tag }}"
    region: "{{ aws_region }}"
    state: absent

- name: Fail if unable to delete the SG for any other reason than the Dependancy violation
  ansible.builtin.fail:
    msg: "{{ delete_sg.error.code}}: {{ delete_sg.error.message }}"
  when: delete_sg.error.code is defined and delete_sg.error.code != "DependencyViolation"
